---
title: "Research Analysis Notebook"
---

```{r}
#| label: setup
#| include: false
library(here)
source(here("utils","check_packages.R"))
source(here("utils","functions.R"))
load(here("data","data_constructed","models.RData"))
load(here("data","data_constructed","markets.RData"))
```



```{r}
#| label: create-coef-table
get_coefs <- function(x) {
  temp <- coef(x)[,c(1,2)]
  return(tibble(variable=rownames(temp), coef=temp[,1], se=temp[,2]))
}
coef <- get_coefs(model) |>
  filter(str_detect(variable, "race_exog")) |>
  mutate(variable=str_replace(variable, "race_exog",""))
  
```


```{r}
#| label: fig-odds-ratios-single
#| fig-cap: Odds of interracial marriage with single race groups for each multiracial group
temp <- coef |> 
  filter(!str_detect(variable, "/|Latino")) |>
  mutate(multiple_race=str_replace(variable, "\\.", "/"),
         multiple_race=factor(multiple_race,
                              levels=c("White/Asian","Black/Indigenous",
                                       "White/Indigenous","Indigenous/Asian",
                                       "White/Black","Black/Asian")))
coef |>
  filter(str_detect(variable, "White/Asian|White/Black|White/Indigenous|Black/Asian|Black/Indigenous|Indigenous/Asian")) |>
  mutate(single_race=str_split(variable, "\\.", simplify=TRUE)[,1],
         multiple_race=str_split(variable, "\\.", simplify=TRUE)[,2],
         constituent=str_detect(multiple_race, single_race),
         single_race=factor(single_race, 
                            levels=c("Latino","Asian","Indigenous","Black",
                                     "White")),
         multiple_race=factor(multiple_race,
                              levels=c("White/Asian","Black/Asian",
                                       "White/Indigenous","Black/Indigenous",
                                       "White/Black","Indigenous/Asian"))) |>
  ggplot(aes(x=single_race, y=exp(coef), color=constituent))+
  geom_linerange(linewidth=1.25, 
                  aes(ymax=exp(coef+1.386*se), ymin=exp(coef-1.386*se)))+
  geom_linerange(linewidth=0.5, 
                  aes(ymax=exp(coef+1.96*se), ymin=exp(coef-1.96*se)))+
  geom_point(size=2)+
  geom_hline(data=temp, aes(yintercept=exp(coef)), linetype=2, color="red")+
  #geom_hline(yintercept=exp(filter(coef, variable=="Multi/Multi")$coef), 
  #           linetype=2, color="blue")+
  coord_flip()+
  facet_wrap(~multiple_race, ncol=2)+
  scale_y_continuous(limits=c(0,1))+
  scale_color_viridis_d(direction=-1, end=0.75)+
  labs(x="single race partner", y="odds relative to endogamy")+
  theme_bw()
```


```{r}
#| label: create-partner-df
couples <- mar_markets[[1]] |> filter(choice)
temp <- couples |>
  filter(raceh=="White/Black" | racew=="White/Black") |>
  mutate(race_spouse=ifelse(raceh=="White/Black", 
                            as.character(racew), as.character(raceh)))
husbands <- couples |>
  #filter(str_detect(raceh, "/")) |>
  mutate(race_ego=raceh, 
         race_spouse=racew,
         gender="husband") |>
  select(race_ego, race_spouse, gender)
wives <- couples |>
  #filter(str_detect(racew, "/")) |>
  mutate(race_ego=racew, 
         race_spouse=raceh,
         gender="wife") |>
  select(race_ego, race_spouse, gender)
partner_choice <- bind_rows(husbands, wives) |>
  mutate(race_spouse=factor(race_spouse, 
                            levels=c("White","Black","Indigenous","Asian","Latino","White/Black",
                                     "White/Indigenous","White/Asian","Black/Indigenous","Black/Asian",
                                     "Indigenous/Asian")))
```

```{r}
#| label: fig-partner-panel
#| fig-cap: Distribution of partner's race for multiracial respondents, separately by panel
partner_choice |>
  filter(str_detect(race_ego, "/")) |>
  ggplot(aes(x=fct_rev(race_spouse), y=after_stat(prop), group=1))+
  geom_bar(position="dodge")+
  facet_wrap(~race_ego)+
  scale_y_continuous(labels=scales::percent)+
  labs(x=NULL, y=NULL)+
  coord_flip()+
  theme_bw()
```

```{r}
#| label: fig-partner-color
#| fig-cap: Distribution of partner's race for multiracial respondents
partner_choice |>
  filter(str_detect(race_ego, "/")) |>
  mutate(race_ego=factor(race_ego, 
                         levels=c("White/Asian","White/Indigenous","White/Black",
                                  "Indigenous/Asian","Black/Asian","Black/Indigenous"))) |>
  ggplot(aes(x=fct_rev(race_spouse), y=..prop.., group=race_ego, fill=race_ego))+
  geom_bar(position="dodge")+
  scale_y_continuous(labels=scales::percent)+
  scale_fill_manual(values = pnw_palette("Bay", 6))+
  labs(x=NULL, y=NULL)+
  coord_flip()+
  theme_bw()
```


```{r}
#| label: fig-partner-full
#| fig-cap: Distribution of partner's race for all respondents, separately by gender and race of ego respondent
ggplot(partner_choice,
       aes(x=fct_rev(race_spouse), y=..prop.., group=gender, fill=gender))+
  geom_bar(position="dodge")+
  facet_wrap(~race_ego)+
  scale_y_continuous(labels=scales::percent)+
  labs(x=NULL, y=NULL)+
  coord_flip()+
  theme_bw()
```